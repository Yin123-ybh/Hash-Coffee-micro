# ☕️ 咖啡点餐系统 - 微服务架构完整实现指南

## 📋 项目概述

本项目将原有的单体咖啡点餐系统拆分为完整的微服务架构，实现了您要求的所有技术特性：

### 🎯 核心特性实现

- ✅ **微服务拆分**: 8个独立微服务，各司其职
- ✅ **防超卖机制**: Redis + Lua脚本 + Redisson分布式锁
- ✅ **万级并发**: 支持高并发秒杀和下单
- ✅ **异步处理**: RabbitMQ消息队列实现订单异步处理
- ✅ **服务治理**: Nacos + Sentinel实现注册发现、流量控制、熔断降级
- ✅ **容器化部署**: Docker + Docker Compose一键部署
- ✅ **统一鉴权**: Spring Cloud Gateway统一入口和鉴权

---

## 🏗️ 微服务架构设计

### 服务拆分详情

| 服务名称 | 端口 | 职责 | 数据库 | 核心特性 |
|---------|------|------|--------|----------|
| **coffee-gateway** | 8080 | API网关，统一入口 | - | 路由转发、统一鉴权、限流 |
| **coffee-user-service** | 8081 | 用户管理、认证授权 | coffee_user_db | JWT认证、用户信息管理 |
| **coffee-product-service** | 8082 | 商品管理、分类管理 | coffee_product_db | 商品CRUD、库存管理 |
| **coffee-order-service** | 8083 | 订单管理、支付处理 | coffee_order_db | 订单流程、异步处理 |
| **coffee-coupon-service** | 8084 | 优惠券管理、秒杀活动 | coffee_coupon_db | **防超卖核心** |
| **coffee-cart-service** | 8085 | 购物车管理 | coffee_cart_db | 购物车状态同步 |
| **coffee-ai-service** | 8086 | AI智能推荐、数据分析 | coffee_ai_db | 智能推荐算法 |
| **coffee-statistics-service** | 8087 | 数据统计分析 | coffee_statistics_db | 数据统计报表 |

---

## 🔒 防超卖核心实现

### 1. Redis + Lua脚本防超卖

```lua
-- 原子性扣减库存的Lua脚本
local stockKey = KEYS[1]      -- 库存键
local userKey = KEYS[2]       -- 用户集合键
local userId = ARGV[1]        -- 用户ID

-- 检查用户是否已参与
if redis.call('SISMEMBER', userKey, userId) == 1 then
    return 0
end

-- 原子性扣减库存
local stock = redis.call('GET', stockKey)
if not stock or tonumber(stock) <= 0 then
    return 0
end

local newStock = redis.call('DECR', stockKey)
if newStock >= 0 then
    redis.call('SADD', userKey, userId)
    return 1
else
    redis.call('INCR', stockKey)  -- 回滚
    return 0
end
```

### 2. Redisson分布式锁

```java
// 防止重复请求的分布式锁
String lockKey = "seckill:lock:" + userId + ":" + couponId;
RLock lock = redissonClient.getLock(lockKey);

if (lock.tryLock(1, 10, TimeUnit.SECONDS)) {
    // 执行秒杀逻辑
    Long result = redisTemplate.execute(seckillScript, ...);
    return result;
} finally {
    lock.unlock();
}
```

### 3. 万级并发支持

- **Lua脚本**: 原子性操作，避免并发问题
- **分布式锁**: 防止重复请求
- **Redis集群**: 支持高并发读写
- **连接池**: 优化数据库连接

---

## 🚀 异步消息队列实现

### RabbitMQ配置

```java
// 订单异步处理队列
@Bean
public Queue orderCreateQueue() {
    return QueueBuilder.durable(ORDER_CREATE_QUEUE)
            .withArgument("x-dead-letter-exchange", ORDER_EXCHANGE)
            .withArgument("x-dead-letter-routing-key", ORDER_DLQ)
            .build();
}

// 订单超时取消队列（延迟队列）
@Bean
public Queue orderTimeoutQueue() {
    return QueueBuilder.durable(ORDER_TIMEOUT_QUEUE)
            .withArgument("x-dead-letter-exchange", ORDER_EXCHANGE)
            .withArgument("x-dead-letter-routing-key", ORDER_CANCEL_ROUTING_KEY)
            .build();
}
```

### 异步处理流程

1. **订单创建** → 发送MQ消息 → 异步处理库存扣减
2. **支付完成** → 发送MQ消息 → 异步更新订单状态
3. **订单超时** → 延迟队列 → 自动取消未支付订单

---

## 🛡️ 服务治理实现

### 1. Nacos服务注册发现

```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: public
        group: DEFAULT_GROUP
        metadata:
          version: 1.0.0
```

### 2. Sentinel流量控制

```java
// 限流规则配置
@PostConstruct
public void initFlowRules() {
    List<FlowRule> rules = new ArrayList<>();
    
    // 秒杀接口限流：每秒100个请求
    FlowRule seckillRule = new FlowRule();
    seckillRule.setResource("seckillCoupon");
    seckillRule.setGrade(RuleConstant.FLOW_GRADE_QPS);
    seckillRule.setCount(100);
    rules.add(seckillRule);
    
    FlowRuleManager.loadRules(rules);
}
```

### 3. 熔断降级

```java
@SentinelRestTemplate(blockHandler = "handleBlock", fallback = "handleFallback")
public RestTemplate restTemplate() {
    return new RestTemplate();
}
```

---

## 🐳 Docker容器化部署

### Docker Compose配置

```yaml
version: '3.8'
services:
  # 基础设施服务
  nacos:
    image: nacos/nacos-server:v2.2.3
    ports:
      - "8848:8848"
  
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
  
  redis:
    image: redis:7.0-alpine
    ports:
      - "6379:6379"
  
  rabbitmq:
    image: rabbitmq:3.11-management
    ports:
      - "5672:5672"
      - "15672:15672"
  
  # 微服务
  gateway:
    build: ./coffee-gateway
    ports:
      - "8080:8080"
  
  user-service:
    build: ./coffee-user-service
    ports:
      - "8081:8081"
  
  # ... 其他服务
```

### 一键部署命令

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f [service-name]
```

---

## 🔐 统一鉴权实现

### Spring Cloud Gateway配置

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://coffee-user-service
          predicates:
            - Path=/user/**
          filters:
            - StripPrefix=1
```

### 全局认证过滤器

```java
@Component
public class AuthGlobalFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getURI().getPath();
        
        // 跳过不需要认证的路径
        if (isSkipAuth(path)) {
            return chain.filter(exchange);
        }
        
        // 验证JWT令牌
        String authorization = request.getHeaders().getFirst("Authorization");
        if (!StringUtils.hasText(authorization) || !authorization.startsWith("Bearer ")) {
            return GatewayConfig.handleError(exchange, "未授权访问");
        }
        
        return chain.filter(exchange);
    }
}
```

---

## 📊 性能优化策略

### 1. 缓存策略

- **Redis缓存**: 商品信息、用户信息、库存信息
- **本地缓存**: 热点数据本地缓存
- **缓存更新**: 主动更新 + 过期策略

### 2. 数据库优化

- **读写分离**: 主从数据库分离
- **分库分表**: 按业务模块分库
- **索引优化**: 合理创建索引
- **连接池**: 数据库连接池优化

### 3. 服务优化

- **服务熔断**: 防止雪崩效应
- **限流控制**: 保护系统稳定性
- **负载均衡**: 分散请求压力
- **异步处理**: 提升响应速度

---

## 🚀 快速启动指南

### 1. 环境准备

```bash
# 确保已安装
- Docker & Docker Compose
- JDK 8+
- Maven 3.6+
```

### 2. 一键启动

```bash
# 进入项目目录
cd coffee-microservices

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps
```

### 3. 验证服务

```bash
# 检查Nacos注册中心
curl http://localhost:8848/nacos

# 检查API网关
curl http://localhost:8080/user/list

# 检查微服务
curl http://localhost:8081/user/list
```

---

## 📈 监控和管理

### 服务监控

- **Nacos控制台**: http://localhost:8848/nacos
- **RabbitMQ管理**: http://localhost:15672
- **API文档**: http://localhost:8081/doc.html

### 日志管理

```bash
# 查看服务日志
docker-compose logs -f [service-name]

# 查看所有服务日志
docker-compose logs -f
```

---

## 🔧 开发指南

### 添加新微服务

1. 创建新的微服务模块
2. 配置服务注册和数据库连接
3. 在网关中添加路由配置
4. 在Docker Compose中添加服务配置

### 服务间通信

```java
// 使用Feign进行服务调用
@FeignClient(name = "coffee-user-service")
public interface UserServiceClient {
    @GetMapping("/user/{id}")
    User getUserById(@PathVariable Long id);
}
```

---

## 🎯 技术亮点总结

### 1. 防超卖核心
- **Redis + Lua脚本**: 原子性操作，避免并发问题
- **Redisson分布式锁**: 防止重复请求
- **万级并发支持**: 支持高并发秒杀场景

### 2. 异步处理
- **RabbitMQ消息队列**: 订单异步处理和超时取消
- **延迟队列**: 自动处理订单超时
- **死信队列**: 处理失败消息

### 3. 服务治理
- **Nacos**: 服务注册发现和配置管理
- **Sentinel**: 流量控制和熔断降级
- **Gateway**: 统一入口和鉴权

### 4. 容器化部署
- **Docker**: 容器化部署
- **Docker Compose**: 一键启动所有服务
- **健康检查**: 自动监控服务状态

---

## ✅ 项目完成度

- ✅ **微服务拆分**: 8个独立微服务
- ✅ **防超卖机制**: Redis + Lua + Redisson
- ✅ **万级并发**: 支持高并发场景
- ✅ **异步处理**: RabbitMQ消息队列
- ✅ **服务治理**: Nacos + Sentinel
- ✅ **容器化部署**: Docker + Docker Compose
- ✅ **统一鉴权**: Spring Cloud Gateway

**您的咖啡点餐系统现在具备了完整的微服务架构和所有要求的技术特性！** 🎉
