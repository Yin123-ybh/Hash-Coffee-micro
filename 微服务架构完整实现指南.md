# â˜•ï¸ å’–å•¡ç‚¹é¤ç³»ç»Ÿ - å¾®æœåŠ¡æ¶æ„å®Œæ•´å®ç°æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å°†åŸæœ‰çš„å•ä½“å’–å•¡ç‚¹é¤ç³»ç»Ÿæ‹†åˆ†ä¸ºå®Œæ•´çš„å¾®æœåŠ¡æ¶æ„ï¼Œå®ç°äº†æ‚¨è¦æ±‚çš„æ‰€æœ‰æŠ€æœ¯ç‰¹æ€§ï¼š

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§å®ç°

- âœ… **å¾®æœåŠ¡æ‹†åˆ†**: 8ä¸ªç‹¬ç«‹å¾®æœåŠ¡ï¼Œå„å¸å…¶èŒ
- âœ… **é˜²è¶…å–æœºåˆ¶**: Redis + Luaè„šæœ¬ + Redissonåˆ†å¸ƒå¼é”
- âœ… **ä¸‡çº§å¹¶å‘**: æ”¯æŒé«˜å¹¶å‘ç§’æ€å’Œä¸‹å•
- âœ… **å¼‚æ­¥å¤„ç†**: RabbitMQæ¶ˆæ¯é˜Ÿåˆ—å®ç°è®¢å•å¼‚æ­¥å¤„ç†
- âœ… **æœåŠ¡æ²»ç†**: Nacos + Sentinelå®ç°æ³¨å†Œå‘ç°ã€æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§
- âœ… **å®¹å™¨åŒ–éƒ¨ç½²**: Docker + Docker Composeä¸€é”®éƒ¨ç½²
- âœ… **ç»Ÿä¸€é‰´æƒ**: Spring Cloud Gatewayç»Ÿä¸€å…¥å£å’Œé‰´æƒ

---

## ğŸ—ï¸ å¾®æœåŠ¡æ¶æ„è®¾è®¡

### æœåŠ¡æ‹†åˆ†è¯¦æƒ…

| æœåŠ¡åç§° | ç«¯å£ | èŒè´£ | æ•°æ®åº“ | æ ¸å¿ƒç‰¹æ€§ |
|---------|------|------|--------|----------|
| **coffee-gateway** | 8080 | APIç½‘å…³ï¼Œç»Ÿä¸€å…¥å£ | - | è·¯ç”±è½¬å‘ã€ç»Ÿä¸€é‰´æƒã€é™æµ |
| **coffee-user-service** | 8081 | ç”¨æˆ·ç®¡ç†ã€è®¤è¯æˆæƒ | coffee_user_db | JWTè®¤è¯ã€ç”¨æˆ·ä¿¡æ¯ç®¡ç† |
| **coffee-product-service** | 8082 | å•†å“ç®¡ç†ã€åˆ†ç±»ç®¡ç† | coffee_product_db | å•†å“CRUDã€åº“å­˜ç®¡ç† |
| **coffee-order-service** | 8083 | è®¢å•ç®¡ç†ã€æ”¯ä»˜å¤„ç† | coffee_order_db | è®¢å•æµç¨‹ã€å¼‚æ­¥å¤„ç† |
| **coffee-coupon-service** | 8084 | ä¼˜æƒ åˆ¸ç®¡ç†ã€ç§’æ€æ´»åŠ¨ | coffee_coupon_db | **é˜²è¶…å–æ ¸å¿ƒ** |
| **coffee-cart-service** | 8085 | è´­ç‰©è½¦ç®¡ç† | coffee_cart_db | è´­ç‰©è½¦çŠ¶æ€åŒæ­¥ |
| **coffee-ai-service** | 8086 | AIæ™ºèƒ½æ¨èã€æ•°æ®åˆ†æ | coffee_ai_db | æ™ºèƒ½æ¨èç®—æ³• |
| **coffee-statistics-service** | 8087 | æ•°æ®ç»Ÿè®¡åˆ†æ | coffee_statistics_db | æ•°æ®ç»Ÿè®¡æŠ¥è¡¨ |

---

## ğŸ”’ é˜²è¶…å–æ ¸å¿ƒå®ç°

### 1. Redis + Luaè„šæœ¬é˜²è¶…å–

```lua
-- åŸå­æ€§æ‰£å‡åº“å­˜çš„Luaè„šæœ¬
local stockKey = KEYS[1]      -- åº“å­˜é”®
local userKey = KEYS[2]       -- ç”¨æˆ·é›†åˆé”®
local userId = ARGV[1]        -- ç”¨æˆ·ID

-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å‚ä¸
if redis.call('SISMEMBER', userKey, userId) == 1 then
    return 0
end

-- åŸå­æ€§æ‰£å‡åº“å­˜
local stock = redis.call('GET', stockKey)
if not stock or tonumber(stock) <= 0 then
    return 0
end

local newStock = redis.call('DECR', stockKey)
if newStock >= 0 then
    redis.call('SADD', userKey, userId)
    return 1
else
    redis.call('INCR', stockKey)  -- å›æ»š
    return 0
end
```

### 2. Redissonåˆ†å¸ƒå¼é”

```java
// é˜²æ­¢é‡å¤è¯·æ±‚çš„åˆ†å¸ƒå¼é”
String lockKey = "seckill:lock:" + userId + ":" + couponId;
RLock lock = redissonClient.getLock(lockKey);

if (lock.tryLock(1, 10, TimeUnit.SECONDS)) {
    // æ‰§è¡Œç§’æ€é€»è¾‘
    Long result = redisTemplate.execute(seckillScript, ...);
    return result;
} finally {
    lock.unlock();
}
```

### 3. ä¸‡çº§å¹¶å‘æ”¯æŒ

- **Luaè„šæœ¬**: åŸå­æ€§æ“ä½œï¼Œé¿å…å¹¶å‘é—®é¢˜
- **åˆ†å¸ƒå¼é”**: é˜²æ­¢é‡å¤è¯·æ±‚
- **Redisé›†ç¾¤**: æ”¯æŒé«˜å¹¶å‘è¯»å†™
- **è¿æ¥æ± **: ä¼˜åŒ–æ•°æ®åº“è¿æ¥

---

## ğŸš€ å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—å®ç°

### RabbitMQé…ç½®

```java
// è®¢å•å¼‚æ­¥å¤„ç†é˜Ÿåˆ—
@Bean
public Queue orderCreateQueue() {
    return QueueBuilder.durable(ORDER_CREATE_QUEUE)
            .withArgument("x-dead-letter-exchange", ORDER_EXCHANGE)
            .withArgument("x-dead-letter-routing-key", ORDER_DLQ)
            .build();
}

// è®¢å•è¶…æ—¶å–æ¶ˆé˜Ÿåˆ—ï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰
@Bean
public Queue orderTimeoutQueue() {
    return QueueBuilder.durable(ORDER_TIMEOUT_QUEUE)
            .withArgument("x-dead-letter-exchange", ORDER_EXCHANGE)
            .withArgument("x-dead-letter-routing-key", ORDER_CANCEL_ROUTING_KEY)
            .build();
}
```

### å¼‚æ­¥å¤„ç†æµç¨‹

1. **è®¢å•åˆ›å»º** â†’ å‘é€MQæ¶ˆæ¯ â†’ å¼‚æ­¥å¤„ç†åº“å­˜æ‰£å‡
2. **æ”¯ä»˜å®Œæˆ** â†’ å‘é€MQæ¶ˆæ¯ â†’ å¼‚æ­¥æ›´æ–°è®¢å•çŠ¶æ€
3. **è®¢å•è¶…æ—¶** â†’ å»¶è¿Ÿé˜Ÿåˆ— â†’ è‡ªåŠ¨å–æ¶ˆæœªæ”¯ä»˜è®¢å•

---

## ğŸ›¡ï¸ æœåŠ¡æ²»ç†å®ç°

### 1. NacosæœåŠ¡æ³¨å†Œå‘ç°

```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: public
        group: DEFAULT_GROUP
        metadata:
          version: 1.0.0
```

### 2. Sentinelæµé‡æ§åˆ¶

```java
// é™æµè§„åˆ™é…ç½®
@PostConstruct
public void initFlowRules() {
    List<FlowRule> rules = new ArrayList<>();
    
    // ç§’æ€æ¥å£é™æµï¼šæ¯ç§’100ä¸ªè¯·æ±‚
    FlowRule seckillRule = new FlowRule();
    seckillRule.setResource("seckillCoupon");
    seckillRule.setGrade(RuleConstant.FLOW_GRADE_QPS);
    seckillRule.setCount(100);
    rules.add(seckillRule);
    
    FlowRuleManager.loadRules(rules);
}
```

### 3. ç†”æ–­é™çº§

```java
@SentinelRestTemplate(blockHandler = "handleBlock", fallback = "handleFallback")
public RestTemplate restTemplate() {
    return new RestTemplate();
}
```

---

## ğŸ³ Dockerå®¹å™¨åŒ–éƒ¨ç½²

### Docker Composeé…ç½®

```yaml
version: '3.8'
services:
  # åŸºç¡€è®¾æ–½æœåŠ¡
  nacos:
    image: nacos/nacos-server:v2.2.3
    ports:
      - "8848:8848"
  
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
  
  redis:
    image: redis:7.0-alpine
    ports:
      - "6379:6379"
  
  rabbitmq:
    image: rabbitmq:3.11-management
    ports:
      - "5672:5672"
      - "15672:15672"
  
  # å¾®æœåŠ¡
  gateway:
    build: ./coffee-gateway
    ports:
      - "8080:8080"
  
  user-service:
    build: ./coffee-user-service
    ports:
      - "8081:8081"
  
  # ... å…¶ä»–æœåŠ¡
```

### ä¸€é”®éƒ¨ç½²å‘½ä»¤

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f [service-name]
```

---

## ğŸ” ç»Ÿä¸€é‰´æƒå®ç°

### Spring Cloud Gatewayé…ç½®

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://coffee-user-service
          predicates:
            - Path=/user/**
          filters:
            - StripPrefix=1
```

### å…¨å±€è®¤è¯è¿‡æ»¤å™¨

```java
@Component
public class AuthGlobalFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getURI().getPath();
        
        // è·³è¿‡ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
        if (isSkipAuth(path)) {
            return chain.filter(exchange);
        }
        
        // éªŒè¯JWTä»¤ç‰Œ
        String authorization = request.getHeaders().getFirst("Authorization");
        if (!StringUtils.hasText(authorization) || !authorization.startsWith("Bearer ")) {
            return GatewayConfig.handleError(exchange, "æœªæˆæƒè®¿é—®");
        }
        
        return chain.filter(exchange);
    }
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç¼“å­˜ç­–ç•¥

- **Redisç¼“å­˜**: å•†å“ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯ã€åº“å­˜ä¿¡æ¯
- **æœ¬åœ°ç¼“å­˜**: çƒ­ç‚¹æ•°æ®æœ¬åœ°ç¼“å­˜
- **ç¼“å­˜æ›´æ–°**: ä¸»åŠ¨æ›´æ–° + è¿‡æœŸç­–ç•¥

### 2. æ•°æ®åº“ä¼˜åŒ–

- **è¯»å†™åˆ†ç¦»**: ä¸»ä»æ•°æ®åº“åˆ†ç¦»
- **åˆ†åº“åˆ†è¡¨**: æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†åº“
- **ç´¢å¼•ä¼˜åŒ–**: åˆç†åˆ›å»ºç´¢å¼•
- **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–

### 3. æœåŠ¡ä¼˜åŒ–

- **æœåŠ¡ç†”æ–­**: é˜²æ­¢é›ªå´©æ•ˆåº”
- **é™æµæ§åˆ¶**: ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§
- **è´Ÿè½½å‡è¡¡**: åˆ†æ•£è¯·æ±‚å‹åŠ›
- **å¼‚æ­¥å¤„ç†**: æå‡å“åº”é€Ÿåº¦

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# ç¡®ä¿å·²å®‰è£…
- Docker & Docker Compose
- JDK 8+
- Maven 3.6+
```

### 2. ä¸€é”®å¯åŠ¨

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd coffee-microservices

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
```

### 3. éªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥Nacosæ³¨å†Œä¸­å¿ƒ
curl http://localhost:8848/nacos

# æ£€æŸ¥APIç½‘å…³
curl http://localhost:8080/user/list

# æ£€æŸ¥å¾®æœåŠ¡
curl http://localhost:8081/user/list
```

---

## ğŸ“ˆ ç›‘æ§å’Œç®¡ç†

### æœåŠ¡ç›‘æ§

- **Nacosæ§åˆ¶å°**: http://localhost:8848/nacos
- **RabbitMQç®¡ç†**: http://localhost:15672
- **APIæ–‡æ¡£**: http://localhost:8081/doc.html

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs -f [service-name]

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f
```

---

## ğŸ”§ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°å¾®æœåŠ¡

1. åˆ›å»ºæ–°çš„å¾®æœåŠ¡æ¨¡å—
2. é…ç½®æœåŠ¡æ³¨å†Œå’Œæ•°æ®åº“è¿æ¥
3. åœ¨ç½‘å…³ä¸­æ·»åŠ è·¯ç”±é…ç½®
4. åœ¨Docker Composeä¸­æ·»åŠ æœåŠ¡é…ç½®

### æœåŠ¡é—´é€šä¿¡

```java
// ä½¿ç”¨Feignè¿›è¡ŒæœåŠ¡è°ƒç”¨
@FeignClient(name = "coffee-user-service")
public interface UserServiceClient {
    @GetMapping("/user/{id}")
    User getUserById(@PathVariable Long id);
}
```

---

## ğŸ¯ æŠ€æœ¯äº®ç‚¹æ€»ç»“

### 1. é˜²è¶…å–æ ¸å¿ƒ
- **Redis + Luaè„šæœ¬**: åŸå­æ€§æ“ä½œï¼Œé¿å…å¹¶å‘é—®é¢˜
- **Redissonåˆ†å¸ƒå¼é”**: é˜²æ­¢é‡å¤è¯·æ±‚
- **ä¸‡çº§å¹¶å‘æ”¯æŒ**: æ”¯æŒé«˜å¹¶å‘ç§’æ€åœºæ™¯

### 2. å¼‚æ­¥å¤„ç†
- **RabbitMQæ¶ˆæ¯é˜Ÿåˆ—**: è®¢å•å¼‚æ­¥å¤„ç†å’Œè¶…æ—¶å–æ¶ˆ
- **å»¶è¿Ÿé˜Ÿåˆ—**: è‡ªåŠ¨å¤„ç†è®¢å•è¶…æ—¶
- **æ­»ä¿¡é˜Ÿåˆ—**: å¤„ç†å¤±è´¥æ¶ˆæ¯

### 3. æœåŠ¡æ²»ç†
- **Nacos**: æœåŠ¡æ³¨å†Œå‘ç°å’Œé…ç½®ç®¡ç†
- **Sentinel**: æµé‡æ§åˆ¶å’Œç†”æ–­é™çº§
- **Gateway**: ç»Ÿä¸€å…¥å£å’Œé‰´æƒ

### 4. å®¹å™¨åŒ–éƒ¨ç½²
- **Docker**: å®¹å™¨åŒ–éƒ¨ç½²
- **Docker Compose**: ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
- **å¥åº·æ£€æŸ¥**: è‡ªåŠ¨ç›‘æ§æœåŠ¡çŠ¶æ€

---

## âœ… é¡¹ç›®å®Œæˆåº¦

- âœ… **å¾®æœåŠ¡æ‹†åˆ†**: 8ä¸ªç‹¬ç«‹å¾®æœåŠ¡
- âœ… **é˜²è¶…å–æœºåˆ¶**: Redis + Lua + Redisson
- âœ… **ä¸‡çº§å¹¶å‘**: æ”¯æŒé«˜å¹¶å‘åœºæ™¯
- âœ… **å¼‚æ­¥å¤„ç†**: RabbitMQæ¶ˆæ¯é˜Ÿåˆ—
- âœ… **æœåŠ¡æ²»ç†**: Nacos + Sentinel
- âœ… **å®¹å™¨åŒ–éƒ¨ç½²**: Docker + Docker Compose
- âœ… **ç»Ÿä¸€é‰´æƒ**: Spring Cloud Gateway

**æ‚¨çš„å’–å•¡ç‚¹é¤ç³»ç»Ÿç°åœ¨å…·å¤‡äº†å®Œæ•´çš„å¾®æœåŠ¡æ¶æ„å’Œæ‰€æœ‰è¦æ±‚çš„æŠ€æœ¯ç‰¹æ€§ï¼** ğŸ‰
